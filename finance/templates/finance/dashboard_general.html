{% extends "base.html" %}

{% block title %}Dashboard General{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h4 class="mb-1">Dashboard General</h4>
        <p class="text-muted mb-0">KPIs consolidados por mes y comparativo.</p>
    </div>
    <a class="btn btn-outline-secondary" href="{% url 'finance:export-general' %}?year={{ year }}&month={{ month }}">
        <i class="bi bi-download me-1"></i>Exportar CSV
    </a>
</div>

<div class="card p-3 mb-4">
    {% include "partials/period_filter.html" %}
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card kpi-card shadow-sm p-3">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small class="text-muted">Ingresos</small>
                    <h5 class="mb-0">S/ {{ kpis.ingresos_total_mes }}</h5>
                </div>
                <div class="icon bg-success-subtle text-success"><i class="bi bi-cash"></i></div>
            </div>
            {% include "finance/partials/delta_badge.html" with delta=income_delta %}
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card shadow-sm p-3">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small class="text-muted">Gastos Totales</small>
                    <h5 class="mb-0">S/ {{ kpis.gastos_totales_mes }}</h5>
                </div>
                <div class="icon bg-danger-subtle text-danger"><i class="bi bi-graph-down"></i></div>
            </div>
            {% include "finance/partials/delta_badge.html" with delta=expense_delta %}
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card shadow-sm p-3">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small class="text-muted">Ahorros</small>
                    <h5 class="mb-0">S/ {{ kpis.ahorros_total_mes }}</h5>
                </div>
                <div class="icon bg-primary-subtle text-primary"><i class="bi bi-piggy-bank"></i></div>
            </div>
            {% include "finance/partials/delta_badge.html" with delta=saving_delta %}
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card shadow-sm p-3">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <small class="text-muted">Balance</small>
                    <h5 class="mb-0">S/ {{ kpis.balance_mes }}</h5>
                </div>
                <div class="icon bg-info-subtle text-info"><i class="bi bi-bar-chart"></i></div>
            </div>
            {% include "finance/partials/delta_badge.html" with delta=balance_delta %}
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card p-3 shadow-sm">
            <h6 class="mb-2">% Gasto sobre ingreso</h6>
            <h4 class="mb-0">{% if expense_ratio %}{{ expense_ratio|floatformat:1 }}%{% else %}N/A{% endif %}</h4>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card p-3 shadow-sm">
            <h6 class="mb-2">% Ahorro sobre ingreso</h6>
            <h4 class="mb-0">{% if saving_ratio %}{{ saving_ratio|floatformat:1 }}%{% else %}N/A{% endif %}</h4>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card p-3 shadow-sm">
            <h6 class="mb-3">Ingresos vs Gastos vs Ahorros (Últimos 12 meses)</h6>
            <canvas id="generalBarChart" height="140"></canvas>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card p-3 shadow-sm">
            <h6 class="mb-3">Distribución de gastos del mes</h6>
            <canvas id="generalPieChart" height="240"></canvas>
        </div>
    </div>
</div>

<div class="card mt-4 shadow-sm">
    <div class="card-header bg-white">
        <h6 class="mb-0">Top 10 gastos del mes</h6>
    </div>
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Categoría</th>
                    <th>Fecha</th>
                    <th class="text-end">Monto</th>
                </tr>
            </thead>
            <tbody>
                {% for item in top_expenses %}
                    <tr>
                        <td>{{ item.description }}</td>
                        <td>{{ item.category__name }}</td>
                        <td>{{ item.date }}</td>
                        <td class="text-end">S/ {{ item.amount }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">Sin gastos registrados.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const barLabels = {{ bar_labels|safe }};
    const datasets = {{ bar_datasets|safe }};

    new Chart(document.getElementById('generalBarChart'), {
        type: 'bar',
        data: {
            labels: barLabels,
            datasets: [
                { label: 'Ingresos', data: datasets.ingresos, backgroundColor: '#22c55e' },
                { label: 'Gastos fijos', data: datasets.gastos_fijos, backgroundColor: '#ef4444' },
                { label: 'Gastos variables', data: datasets.gastos_variables, backgroundColor: '#f97316' },
                { label: 'Ahorros', data: datasets.ahorros, backgroundColor: '#3b82f6' },
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('generalPieChart'), {
        type: 'doughnut',
        data: {
            labels: {{ pie_labels|safe }},
            datasets: [{ data: {{ pie_data|safe }}, backgroundColor: ['#ef4444', '#f97316', '#3b82f6', '#22c55e', '#6366f1'] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
</script>
{% endblock %}
