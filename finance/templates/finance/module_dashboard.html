{% extends "base.html" %}

{% block header %}Dashboard {{ slug|title }}{% endblock %}

{% block content %}
<form class="row g-2 align-items-end mb-4" method="get">
    <div class="col-md-2">
        <label class="form-label">Año</label>
        <input type="number" name="year" class="form-control" value="{{ year }}">
    </div>
    <div class="col-md-2">
        <label class="form-label">Mes</label>
        <select name="month" class="form-select">
            {% for m in months %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary" type="submit">Aplicar</button>
    </div>
</form>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card card-kpi p-3">
            <div class="text-muted">Total del mes</div>
            <div class="h4">${{ total_month }}</div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card p-3">
            <h6>Totales últimos 12 meses</h6>
            <canvas id="moduleBar"></canvas>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card p-3">
            <h6>Distribución por categoría</h6>
            <canvas id="modulePie"></canvas>
        </div>
    </div>
</div>

<div class="card mt-4 p-3">
    <h6>Evolución diaria del mes</h6>
    <canvas id="moduleLine"></canvas>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const last12 = {{ last_12|safe }};
    const categoryData = {{ category_data|safe }};
    const dailySeries = {{ daily_series|safe }};

    new Chart(document.getElementById('moduleBar'), {
        type: 'bar',
        data: {
            labels: last12.labels,
            datasets: [{label: 'Total', data: last12.data, backgroundColor: '#6366f1'}]
        },
        options: {responsive: true, plugins: {legend: {display: false}}}
    });

    new Chart(document.getElementById('modulePie'), {
        type: 'doughnut',
        data: {
            labels: categoryData.labels,
            datasets: [{data: categoryData.data, backgroundColor: ['#6366f1', '#14b8a6', '#f97316', '#fb7185', '#a855f7']}]
        },
        options: {responsive: true, plugins: {legend: {position: 'bottom'}}}
    });

    new Chart(document.getElementById('moduleLine'), {
        type: 'line',
        data: {
            labels: dailySeries.labels,
            datasets: [{label: 'Total diario', data: dailySeries.data, borderColor: '#1d4ed8', backgroundColor: 'rgba(29,78,216,0.15)'}]
        },
        options: {responsive: true}
    });
</script>
{% endblock %}
